<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KGS - Secure Chat</title>
    
    <!-- PrÃ©-connexion pour accÃ©lÃ©rer le tÃ©lÃ©chargement -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://esm.sh">
    <link rel="preconnect" href="https://www.gstatic.com">

    <!-- Styles critiques pour l'Ã©cran de chargement (s'affiche AVANT tout le reste) -->
    <style>
        body { margin: 0; padding: 0; background-color: #fff1f2; font-family: system-ui, -apple-system, sans-serif; }
        .app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #fff1f2; z-index: 9999;
        }
        .loader-icon {
            width: 60px; height: 60px; background-color: #ffe4e6; color: #f43f5e;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(244, 63, 94, 0.2);
            font-size: 24px; font-weight: bold;
        }
        .loader-text { color: #f43f5e; font-weight: 900; font-size: 24px; letter-spacing: -1px; margin-bottom: 8px; }
        .loader-sub { color: #fb7185; font-size: 12px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; }
        .spinner {
            width: 20px; height: 20px; border: 3px solid #fecdd3; border-top-color: #f43f5e;
            border-radius: 50%; animation: spin 1s linear infinite; margin-top: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Masquer la scrollbar tout en gardant le scroll */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #fecdd3; border-radius: 20px; }
        body { -webkit-tap-highlight-color: transparent; }
    </style>

    <!-- 1. TAILWIND -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: { extend: { colors: { rose: { 50: '#fff1f2', 100: '#ffe4e6', 200: '#fecdd3', 300: '#fda4af', 400: '#fb7185', 500: '#f43f5e', 600: '#e11d48' } } } }
        }
    </script>
</head>
<body>

    <!-- Ã‰cran de chargement HTML pur (Visible immÃ©diatement) -->
    <div id="root">
        <div class="app-loader">
            <div class="loader-icon">K</div>
            <div class="loader-text">KGS</div>
            <div class="loader-sub">CONNEXION SÃ‰CURISÃ‰E...</div>
            <div class="spinner"></div>
        </div>
    </div>

    <!-- 3. CODE REACT -->
    <script type="text/babel" data-type="module">
        
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, getDocs, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { Send, Shield, LogOut, EyeOff, MessageCircle, Heart, Mic, Trash2, Plus, ArrowRight, Copy, Hash, Users, Crown, Activity, Server, Eye, LockKeyhole, Bomb, AlertTriangle, Reply, X, UserMinus, Ban } from 'https://esm.sh/lucide-react@0.344.0';

        const firebaseConfig = {
            apiKey: "AIzaSyBQYoOdP2D0detYEtlpspZrizrXRDHQerg",
            authDomain: "kgs-c6e96.firebaseapp.com",
            projectId: "kgs-c6e96",
            storageBucket: "kgs-c6e96.firebasestorage.app",
            messagingSenderId: "135233323872",
            appId: "1:135233323872:web:1bdb1794a3d34d72839405"
        };

        let app, auth, db, appId;
        let isFirebaseAvailable = false;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = firebaseConfig.projectId;
            isFirebaseAvailable = true;
        } catch (error) { console.error("Erreur Firebase:", error); }

        const ROOMS_COLLECTION = 'kgs_rooms_v4';
        const USERS_COLLECTION = 'kgs_users_v4';

        function KGSApp() {
            const [user, setUser] = useState(null);
            const [username, setUsername] = useState('');
            const [isSetup, setIsSetup] = useState(false);
            const [loading, setLoading] = useState(true);
            const [demoMode, setDemoMode] = useState(!isFirebaseAvailable);
            
            const [isAdmin, setIsAdmin] = useState(false);
            const [adminStats, setAdminStats] = useState({ users: 0, rooms: 0 });
            const [adminRoomList, setAdminRoomList] = useState([]);
            
            const [currentRoom, setCurrentRoom] = useState(null);
            const [roomData, setRoomData] = useState(null);
            const [roomInput, setRoomInput] = useState('');
            const [messages, setMessages] = useState([]);
            const [showMembers, setShowMembers] = useState(false);
            
            const [newMessage, setNewMessage] = useState('');
            const [replyTo, setReplyTo] = useState(null);
            const [isRecording, setIsRecording] = useState(false);
            const [recordingTime, setRecordingTime] = useState(0);
            
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);
            const timerRef = useRef(null);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                if (!isFirebaseAvailable) {
                    setTimeout(() => { setDemoMode(true); setUser({ uid: 'demo-user-123' }); setLoading(false); }, 1000);
                    return;
                }
                const initAuth = async () => {
                    try { await signInAnonymously(auth); } 
                    catch (err) { console.error("Auth failed", err); setDemoMode(true); setUser({ uid: 'offline-user' }); setLoading(false); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        const savedName = localStorage.getItem(`kgs_user_${currentUser.uid}`);
                        if (savedName) { setUsername(savedName); setIsSetup(true); if (savedName === 'Whinsklay') setIsAdmin(true); }
                    }
                    setLoading(false);
                });
                return () => unsubscribe && unsubscribe();
            }, []);

            useEffect(() => {
                if (!currentRoom || !user || !db) return;
                setMessages([]); setReplyTo(null);
                if (demoMode) { setMessages([{ id: '1', text: `Salon ${currentRoom}`, senderName: 'Sys', type: 'system', timestamp: { toMillis: () => Date.now() } }]); return; }

                const roomMessagesRef = collection(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION, currentRoom, 'messages');
                const unsubscribeMessages = onSnapshot(roomMessagesRef, (snapshot) => {
                    const loadedMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const sorted = loadedMessages.filter(m => m.timestamp).sort((a, b) => (a.timestamp?.toMillis ? a.timestamp.toMillis() : 0) - (b.timestamp?.toMillis ? b.timestamp.toMillis() : 0));
                    setMessages(sorted.slice(-50));
                });

                const roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION, currentRoom);
                const unsubscribeRoom = onSnapshot(roomDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setRoomData(data);
                        if (data.bannedUsers && data.bannedUsers.includes(user.uid) && !isAdmin) { alert("ExpulsÃ© !"); leaveRoom(true); }
                    } else { leaveRoom(); }
                });
                return () => { unsubscribeMessages(); unsubscribeRoom(); };
            }, [currentRoom, user, demoMode]);

            useEffect(() => {
                if (isAdmin && !demoMode && isSetup) {
                    const fetchAdminData = async () => {
                        try {
                            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', USERS_COLLECTION);
                            const usersSnap = await getDocs(usersRef);
                            const roomsRef = collection(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION);
                            const roomsSnap = await getDocs(roomsRef);
                            const roomsList = roomsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setAdminStats({ users: usersSnap.size, rooms: roomsSnap.size });
                            setAdminRoomList(roomsList);
                        } catch (e) { }
                    };
                    fetchAdminData();
                    const interval = setInterval(fetchAdminData, 10000);
                    return () => clearInterval(interval);
                }
            }, [isAdmin, isSetup, demoMode]);

            useEffect(() => {
                const handleKeyUp = async (e) => {
                    if (e.key === 'PrintScreen' && currentRoom && user && !isAdmin && !demoMode) {
                        try {
                            const roomRef = collection(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION, currentRoom, 'messages');
                            await addDoc(roomRef, { text: `${username} a pris une CAPTURE D'Ã‰CRAN ! ðŸ“¸`, senderId: 'system_alert', senderName: 'SÃ‰CURITÃ‰', timestamp: serverTimestamp(), type: 'alert' });
                        } catch (err) {}
                    }
                };
                window.addEventListener('keyup', handleKeyUp);
                return () => window.removeEventListener('keyup', handleKeyUp);
            }, [currentRoom, user, username, isAdmin, demoMode]);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const generateRoomCode = () => {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 6; i > 0; i--) result += chars[Math.floor(Math.random() * chars.length)];
                return `KGS-${result}`;
            };

            const createRoom = async () => {
                const newCode = generateRoomCode();
                if (!demoMode && user) {
                    try {
                        const roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION, newCode);
                        await setDoc(roomDocRef, { createdAt: serverTimestamp(), creator: username, creatorId: user.uid, activeUsers: [], bannedUsers: [], active: true });
                    } catch(e) {}
                }
                joinRoom(newCode);
            };

            const joinRoom = async (roomCode) => {
                if (!demoMode && user) {
                    const roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION, roomCode);
                    const docSnap = await getDoc(roomDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.bannedUsers && data.bannedUsers.includes(user.uid) && !isAdmin) { alert("Banni !"); return; }
                    }
                }
                setCurrentRoom(roomCode); setMessages([]);
                if (!isAdmin && !demoMode && user && db) {
                    try {
                        const roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION, roomCode);
                        await updateDoc(roomDocRef, { activeUsers: arrayUnion({ uid: user.uid, name: username }) });
                        const roomRef = collection(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION, roomCode, 'messages');
                        await addDoc(roomRef, { text: `${username} a rejoint le canal.`, senderId: 'system', senderName: 'LOG', timestamp: serverTimestamp(), type: 'system' });
                    } catch (e) {}
                }
            };

            const leaveRoom = async (forced = false) => { setCurrentRoom(null); setMessages([]); setRoomInput(''); setReplyTo(null); setShowMembers(false); };

            const kickUser = async (targetUid, targetName) => {
                if (!roomData || (roomData.creatorId !== user.uid && !isAdmin)) return;
                if (targetUid === user.uid) return; 
                if (!window.confirm(`Expulser ${targetName} ?`)) return;
                try {
                    const roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION, currentRoom);
                    await updateDoc(roomDocRef, { bannedUsers: arrayUnion(targetUid), activeUsers: roomData.activeUsers.filter(u => u.uid !== targetUid) });
                    const roomRef = collection(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION, currentRoom, 'messages');
                    await addDoc(roomRef, { text: `${targetName} a Ã©tÃ© expulsÃ©.`, senderId: 'system', senderName: 'SÃ‰CURITÃ‰', timestamp: serverTimestamp(), type: 'system' });
                } catch (e) { alert("Erreur expulsion."); }
            };

            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    audioChunksRef.current = [];
                    mediaRecorderRef.current.ondataavailable = (e) => { if (e.data.size > 0) audioChunksRef.current.push(e.data); };
                    mediaRecorderRef.current.onstop = () => stream.getTracks().forEach(track => track.stop());
                    mediaRecorderRef.current.start();
                    setIsRecording(true); setRecordingTime(0);
                    timerRef.current = setInterval(() => { setRecordingTime(prev => { if (prev >= 15) { stopAndSendRecording(); return 15; } return prev + 1; }); }, 1000);
                } catch (err) { alert("Micro inaccessible"); }
            };

            const stopAndSendRecording = () => { if (mediaRecorderRef.current && isRecording) { mediaRecorderRef.current.stop(); clearInterval(timerRef.current); setIsRecording(false); setTimeout(processAudioAndSend, 500); } };
            const cancelRecording = () => { if (mediaRecorderRef.current && isRecording) { mediaRecorderRef.current.stop(); clearInterval(timerRef.current); setIsRecording(false); audioChunksRef.current = []; } };
            const processAudioAndSend = () => { if (audioChunksRef.current.length === 0) return; const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' }); const reader = new FileReader(); reader.readAsDataURL(audioBlob); reader.onloadend = async () => await sendMessage(null, reader.result); };
            const handleAudioEnded = async (messageId) => { if (demoMode || !db || !currentRoom || isAdmin) return; try { const msgRef = doc(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION, currentRoom, 'messages', messageId); await updateDoc(msgRef, { listenedBy: arrayUnion(user.uid) }); } catch (e) {} };

            const sendMessage = async (textInfo, audioInfo) => {
                if (isAdmin || ((!textInfo && !audioInfo) || !user || !currentRoom)) return;
                const msg = {
                    senderId: user.uid, senderName: username || 'Inconnu', timestamp: serverTimestamp(),
                    type: audioInfo ? 'audio' : 'text', text: audioInfo ? 'Audio (Auto-destruction)' : textInfo,
                    audioData: audioInfo || null, listenedBy: [],
                    replyTo: replyTo ? { id: replyTo.id, senderName: replyTo.senderName, text: replyTo.type === 'audio' ? 'Vocal' : replyTo.text.substring(0, 50) + '...' } : null
                };
                if (demoMode) { setMessages(prev => [...prev, { ...msg, id: Date.now().toString(), timestamp: { toMillis: () => Date.now() } }]); } 
                else { try { const roomRef = collection(db, 'artifacts', appId, 'public', 'data', ROOMS_COLLECTION, currentRoom, 'messages'); await addDoc(roomRef, msg); } catch (err) { alert("Erreur envoi."); } }
                setReplyTo(null);
            };

            const handleTextSubmit = (e) => { e.preventDefault(); if (!newMessage.trim()) return; sendMessage(newMessage.trim(), null); setNewMessage(''); };
            const handleSetup = async (e) => { e.preventDefault(); if (username.trim()) { const finalName = username.trim(); const isAdminUser = finalName === 'Whinsklay'; setIsAdmin(isAdminUser); setIsSetup(true); if (user) { localStorage.setItem(`kgs_user_${user.uid}`, finalName); if (!demoMode) { try { const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', USERS_COLLECTION, user.uid); await setDoc(userDocRef, { username: finalName, lastSeen: serverTimestamp(), isAdmin: isAdminUser }); } catch (err) {} } } } };
            const handleLogout = async () => { if (!demoMode && auth) await signOut(auth); setIsSetup(false); setIsAdmin(false); setCurrentRoom(null); setUsername(''); if (demoMode) window.location.reload(); };
            const copyRoomCode = () => navigator.clipboard.writeText(currentRoom);
            const isCreator = roomData?.creatorId === user?.uid;

            // RENDER - Garde le mÃªme style, mais le JSX est maintenant valide
            if (loading) return null; // L'Ã©cran HTML pur s'affiche Ã  la place

            if (!isSetup) return (
                <div className="flex h-screen w-full flex-col items-center justify-center bg-rose-50 p-6 font-sans text-rose-900 animate-in fade-in duration-500">
                    <div className="w-full max-w-sm rounded-3xl bg-white p-8 shadow-[0_20px_60px_-15px_rgba(244,63,94,0.2)] border border-rose-100">
                        <div className="flex flex-col items-center mb-8">
                            <div className="h-20 w-20 bg-rose-100 rounded-full flex items-center justify-center mb-4 text-rose-500 shadow-inner"><MessageCircle size={40} /></div>
                            <h1 className="text-3xl font-black text-rose-500 tracking-tight">KGS</h1>
                            <p className="text-gray-400 text-sm font-medium">Messagerie SecrÃ¨te</p>
                        </div>
                        <form onSubmit={handleSetup} className="space-y-4">
                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-2 pl-2">IdentitÃ©</label><input type="text" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Votre pseudo" className="w-full rounded-2xl bg-gray-50 border-2 border-transparent px-5 py-4 font-bold text-gray-700 placeholder-gray-300 focus:border-rose-300 focus:bg-white focus:outline-none transition-all" autoFocus /></div>
                            <button type="submit" disabled={!username.trim()} className="w-full rounded-2xl bg-rose-500 py-4 font-bold text-white shadow-lg shadow-rose-200 transition-transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50">Connexion</button>
                        </form>
                    </div>
                </div>
            );

            if (!currentRoom) return (
                <div className="flex h-screen w-full flex-col bg-rose-50 font-sans overflow-hidden animate-in fade-in">
                    <header className="flex-none bg-white px-6 py-4 flex justify-between items-center shadow-sm z-10">
                        <div className="flex items-center gap-2"><h1 className="font-black text-xl text-rose-500">KGS</h1>{isAdmin && <span className="bg-black text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase">Admin</span>}</div>
                        <button onClick={handleLogout} className="text-gray-400 hover:text-rose-500"><LogOut size={20}/></button>
                    </header>
                    <div className="flex-1 overflow-y-auto">
                        <div className="flex flex-col items-center justify-center p-6 gap-6 min-h-full">
                            <div className="w-full max-w-md space-y-6">
                                {isAdmin && (
                                    <div className="bg-gray-900 text-white p-6 rounded-3xl shadow-xl border border-gray-800 animate-in slide-in-from-top-4">
                                        <div className="flex items-center gap-3 mb-6 pb-4 border-b border-gray-800">
                                            <Crown size={24} className="text-yellow-500" />
                                            <div><h2 className="font-bold text-lg">Oeil de Dieu</h2><p className="text-xs text-gray-400">Admin Panel</p></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 mb-6">
                                            <div className="bg-gray-800 p-4 rounded-2xl"><div className="flex items-center gap-2 text-rose-400 mb-2"><Users size={18} /><span className="text-xs font-bold uppercase">Users</span></div><p className="text-3xl font-black">{adminStats.users}</p></div>
                                            <div className="bg-gray-800 p-4 rounded-2xl"><div className="flex items-center gap-2 text-blue-400 mb-2"><Server size={18} /><span className="text-xs font-bold uppercase">Salons</span></div><p className="text-3xl font-black">{adminStats.rooms}</p></div>
                                        </div>
                                        <div className="space-y-2">
                                            <p className="text-xs font-bold text-gray-500 uppercase">Salons</p>
                                            <div className="max-h-60 overflow-y-auto pr-2 space-y-2 scrollbar-thin scrollbar-thumb-gray-700">
                                                {adminRoomList.map(room => (
                                                    <div key={room.id} className="flex items-center justify-between bg-gray-800 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                                                        <div><div className="flex items-center gap-2"><span className="font-bold text-sm text-white">{room.id}</span>{!room.active && <span className="text-[9px] bg-red-900 text-red-300 px-1 rounded">FERMÃ‰</span>}</div><p className="text-[10px] text-gray-400">Par: {room.creator}</p></div>
                                                        <button onClick={() => joinRoom(room.id)} className="p-1.5 bg-blue-500/20 text-blue-400 rounded hover:bg-blue-500 hover:text-white"><Eye size={16} /></button>
                                                    </div>
                                                ))}
                                                {adminRoomList.length === 0 && <p className="text-xs text-gray-600">Aucun salon.</p>}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div className="text-center space-y-2 pt-4"><h2 className="text-2xl font-bold text-gray-800">Salons SÃ©curisÃ©s</h2><p className="text-gray-500">Bienvenue, {username}.</p></div>
                                <button onClick={createRoom} className="w-full bg-white p-6 rounded-3xl shadow-sm border-2 border-dashed border-rose-200 hover:border-rose-400 hover:shadow-md transition-all group flex items-center justify-between">
                                    <div className="flex items-center gap-4"><div className="h-12 w-12 rounded-full bg-rose-100 flex items-center justify-center text-rose-500 group-hover:scale-110 transition-transform"><Plus size={24} /></div><div className="text-left"><p className="font-bold text-gray-800">CrÃ©er un salon</p><p className="text-xs text-gray-400">CrÃ©er un canal privÃ©</p></div></div><ArrowRight size={20} className="text-rose-300 group-hover:text-rose-500" />
                                </button>
                                <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                                    <form onSubmit={(e) => { e.preventDefault(); handleJoinSubmit(e); }} className="flex gap-2">
                                        <input type="text" placeholder="CODE" value={roomInput} onChange={(e) => setRoomInput(e.target.value)} className="flex-1 bg-gray-50 rounded-xl px-4 py-3 font-mono text-sm border focus:border-rose-300 focus:outline-none uppercase" />
                                        <button type="submit" disabled={roomInput.length < 3} className="bg-gray-900 text-white px-4 rounded-xl font-bold disabled:opacity-50 hover:bg-black transition-colors">Rejoindre</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen w-full flex-col bg-white font-sans text-gray-800 relative animate-in fade-in">
                    {showMembers && (isCreator || isAdmin) && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/50 p-4 animate-in fade-in">
                        <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                            <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><Users size={20} className="text-rose-500" />Membres</h3><button onClick={() => setShowMembers(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><X size={16}/></button></div>
                            <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                {roomData?.activeUsers?.map((u, idx) => (
                                    <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                    <div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-rose-100 flex items-center justify-center text-rose-500 font-bold text-xs">{u.name.charAt(0)}</div><span className="font-bold text-sm text-gray-700">{u.name} {u.uid === user.uid && "(Moi)"} {u.uid === roomData.creatorId && "ðŸ‘‘"}</span></div>
                                    {u.uid !== user.uid && u.uid !== roomData.creatorId && (<button onClick={() => kickUser(u.uid, u.name)} className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"><UserMinus size={18} /></button>)}
                                    </div>
                                ))}
                                {(!roomData?.activeUsers || roomData.activeUsers.length === 0) && <p className="text-center text-sm text-gray-400">Aucun membre.</p>}
                            </div>
                        </div>
                        </div>
                    )}
                    <header className={`flex-none backdrop-blur-md border-b px-4 py-3 z-10 sticky top-0 ${isAdmin ? 'bg-black/90 border-gray-800 text-white' : 'bg-white/90 border-rose-100'}`}>
                        <div className="flex items-center justify-between max-w-4xl mx-auto">
                            <div className="flex items-center gap-3">
                                <button onClick={() => leaveRoom()} className={`p-2 -ml-2 rounded-full transition-colors ${isAdmin ? 'text-gray-400 hover:text-white hover:bg-gray-800' : 'text-gray-400 hover:text-gray-600 hover:bg-gray-100'}`}><ArrowRight size={20} className="rotate-180" /></button>
                                <div><div className="flex items-center gap-2" onClick={copyRoomCode} role="button"><h1 className={`font-black text-lg leading-none ${isAdmin ? 'text-white' : 'text-gray-800'}`}>{currentRoom}</h1>{!isAdmin && <Copy size={14} className="text-rose-400" />}</div><span className="text-[10px] font-bold text-green-500 uppercase tracking-wider flex items-center gap-1">{isAdmin ? 'Historique' : 'En Ligne'}</span></div>
                            </div>
                            <div className="flex items-center gap-3">
                                {(isCreator || isAdmin) && (<button onClick={() => setShowMembers(true)} className={`p-2 rounded-full ${isAdmin ? 'bg-gray-800 text-yellow-500' : 'bg-rose-100 text-rose-500'} hover:scale-105 transition-transform`}><Users size={18} /></button>)}
                                <div className="hidden sm:flex flex-col items-end"><span className={`text-[10px] font-bold ${isAdmin ? 'text-gray-400' : 'text-gray-400'}`}>{isAdmin ? 'SUPER-ADMIN' : (isCreator ? 'CRÃ‰ATEUR' : 'AGENT')}</span><span className={`text-sm font-bold flex items-center gap-1 ${isAdmin ? 'text-yellow-500' : 'text-rose-500'}`}>{username}{isCreator && !isAdmin && <Crown size={12} className="text-yellow-500 fill-yellow-500"/>}</span></div>
                            </div>
                        </div>
                    </header>
                    <div className={`flex-1 overflow-y-auto scrollbar-thin ${isAdmin ? 'bg-gray-900 scrollbar-thumb-gray-700' : 'bg-gray-50 scrollbar-thumb-rose-200'}`}>
                        <div className="max-w-4xl mx-auto p-4 space-y-6 min-h-full flex flex-col justify-end pb-4">
                            <div className="text-center py-10 opacity-50"><div className={`inline-flex items-center justify-center p-4 rounded-full mb-3 ${isAdmin ? 'bg-gray-800 text-gray-500' : 'bg-rose-100 text-rose-500'}`}>{isAdmin ? <LockKeyhole size={24} /> : <Users size={24} />}</div><p className={`text-sm font-bold ${isAdmin ? 'text-gray-400' : 'text-gray-600'}`}>Salon {currentRoom}</p><p className="text-xs text-gray-500">ChiffrÃ©.</p></div>
                            {messages.map((msg) => {
                                const isMe = msg.senderId === user?.uid;
                                const isSystem = msg.type === 'system';
                                const isAlert = msg.type === 'alert';
                                const isAudio = msg.type === 'audio';
                                const isListened = msg.listenedBy && msg.listenedBy.includes(user?.uid);
                                if (isSystem) return (<div key={msg.id} className="flex justify-center my-4"><span className={`text-[10px] uppercase font-bold px-3 py-1 rounded-full tracking-wide ${isAdmin ? 'bg-gray-800 text-gray-400' : 'bg-gray-200/50 text-gray-500'}`}>{msg.text}</span></div>);
                                if (isAlert) return (<div key={msg.id} className="flex justify-center my-4 animate-bounce"><div className="flex items-center gap-2 bg-red-100 text-red-600 border border-red-200 text-xs font-bold px-4 py-2 rounded-full shadow-sm"><AlertTriangle size={14} />{msg.text}</div></div>);
                                return (
                                    <div key={msg.id} className={`flex w-full ${isMe ? 'justify-end' : 'justify-start'} animate-in slide-in-from-bottom-2 duration-300 group/msg`}>
                                        <div className={`flex flex-col max-w-[85%] sm:max-w-[70%] ${isMe ? 'items-end' : 'items-start'}`}>
                                            <div className="flex items-center gap-2 mb-1 px-2"><span className={`text-[10px] font-bold ${isMe ? (isAdmin ? 'text-yellow-500' : 'text-rose-400') : 'text-gray-400'}`}>{msg.senderName}</span>{!isAdmin && (<button onClick={() => setReplyTo(msg)} className="opacity-0 group-hover/msg:opacity-100 transition-opacity text-gray-400 hover:text-rose-500"><Reply size={12} /></button>)}</div>
                                            <div className={`relative px-4 py-3 rounded-2xl text-sm leading-relaxed shadow-sm break-words ${isMe ? (isAdmin ? 'bg-yellow-600 text-white rounded-tr-sm' : 'bg-rose-500 text-white rounded-tr-sm') : (isAdmin ? 'bg-gray-800 text-gray-300 rounded-tl-sm border-gray-700' : 'bg-white text-gray-700 rounded-tl-sm border border-gray-100')}`}>
                                                {msg.replyTo && (<div className={`mb-2 p-2 rounded-lg text-xs border-l-4 ${isMe ? 'bg-black/10 border-white/50' : 'bg-gray-100 border-rose-300'}`}><p className="font-bold opacity-75 mb-0.5">{msg.replyTo.senderName}</p><p className="opacity-60 truncate">{msg.replyTo.type === 'audio' ? 'Vocal' : msg.replyTo.text}</p></div>)}
                                                {isAudio ? (isListened ? (<div className="flex items-center gap-2 text-xs italic opacity-70"><Bomb size={14} /><span>DÃ©truit</span></div>) : (<div className="flex flex-col gap-1 min-w-[200px]"><div className="flex items-center gap-2 mb-1"><Mic size={14} className={isMe ? 'text-white/70' : (isAdmin ? 'text-gray-400' : 'text-rose-400')} /><span className="text-xs font-bold opacity-80">Unique</span></div><audio controls src={msg.audioData} className="w-full h-8 max-w-[240px]" onEnded={() => handleAudioEnded(msg.id)} /></div>)) : (<p>{msg.text}</p>)}
                                                <div className={`absolute bottom-full mb-1 text-[9px] font-bold px-2 py-1 rounded bg-black/70 text-white opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap ${isMe ? 'right-0' : 'left-0'}`}>{msg.timestamp?.toMillis ? new Date(msg.timestamp.toMillis()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...'}</div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            <div ref={messagesEndRef} />
                        </div>
                    </div>
                    {isAdmin ? (
                        <div className="flex-none bg-black border-t border-gray-800 p-6"><div className="max-w-4xl mx-auto flex items-center justify-center gap-2 text-yellow-500 font-bold tracking-widest text-sm"><Eye size={18} />SPECTATEUR - LECTURE SEULE</div></div>
                    ) : (
                        <div className="flex-none bg-white border-t border-rose-100 p-4 pb-6 sm:pb-4">
                            <div className="max-w-4xl mx-auto">
                                {replyTo && (<div className="flex items-center justify-between bg-gray-50 border-l-4 border-rose-400 p-3 mb-2 rounded-r-lg animate-in slide-in-from-bottom-2"><div><p className="text-xs font-bold text-rose-500">RÃ©ponse Ã  {replyTo.senderName}</p><p className="text-xs text-gray-500 truncate max-w-[200px]">{replyTo.type === 'audio' ? 'Vocal' : replyTo.text}</p></div><button onClick={() => setReplyTo(null)} className="p-1 hover:bg-gray-200 rounded-full"><X size={14} className="text-gray-500"/></button></div>)}
                                {isRecording ? (
                                    <div className="flex items-center gap-3 animate-in fade-in duration-200"><div className="flex-1 bg-rose-50 rounded-2xl border-2 border-rose-200 flex items-center px-4 py-3 gap-3"><div className="relative flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span></div><span className="font-mono text-rose-600 font-bold">REC 00:{recordingTime < 10 ? `0${recordingTime}` : recordingTime} / 00:15</span></div><button onClick={cancelRecording} className="p-4 rounded-2xl bg-gray-100 text-gray-500 hover:bg-gray-200"><Trash2 size={20} /></button><button onClick={stopAndSendRecording} className="h-14 px-6 rounded-2xl bg-rose-500 text-white shadow-lg shadow-rose-200 font-bold flex items-center gap-2"><Send size={18} />ENVOYER</button></div>
                                ) : (
                                    <form onSubmit={handleTextSubmit} className="relative flex items-center gap-3"><div className="relative flex-1 group"><input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)} placeholder={`Message...`} className="w-full pl-5 pr-12 py-4 bg-gray-50 rounded-2xl border-2 border-transparent focus:bg-white focus:border-rose-100 focus:ring-4 focus:ring-rose-50 outline-none transition-all font-medium text-gray-700 placeholder-gray-400" /><EyeOff className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-300 group-focus-within:text-rose-300 transition-colors" size={18} /></div>{newMessage.trim() ? (<button type="submit" className="h-14 w-14 flex items-center justify-center rounded-2xl bg-rose-500 text-white shadow-lg shadow-rose-200 hover:scale-105 transition-all"><Send size={22} className="ml-1" /></button>) : (<button type="button" onClick={startRecording} className="h-14 w-14 flex items-center justify-center rounded-2xl bg-rose-100 text-rose-500 hover:bg-rose-200 hover:scale-105 transition-all"><Mic size={24} /></button>)}</form>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<KGSApp />);

    </script>
</body>
</html>


